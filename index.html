<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>å‹é”ãƒãƒ£ãƒƒãƒˆ</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyDGPCCNoeWuPAhGpKLdabyAU-5hTdHemw8",
  authDomain: "my-chat-app-37b9e.firebaseapp.com",
  databaseURL: "https://my-chat-app-37b9e-default-rtdb.firebaseio.com",
  projectId: "my-chat-app-37b9e",
  storageBucket: "my-chat-app-37b9e.appspot.com",
  messagingSenderId: "111829020213",
  appId: "1:111829020213:web:44f631c678dcb8525c8b7c",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);

const messagesRef = ref(db, "messages");
const chat = document.getElementById("chat");
const textInput = document.getElementById("text");
const sendBtn = document.getElementById("send");
const imageInput = document.getElementById("image");
const stampBtns = document.querySelectorAll(".stamp-btn");

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å—ä¿¡
onValue(messagesRef, (snapshot) => {
  chat.innerHTML = ""; // æ—¢å­˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
  const data = snapshot.val();
  if(data){
    Object.values(data).forEach(msg => {
      const div = document.createElement("div");
      div.className = "message";
      if(msg.image){
        div.innerHTML = `<strong>${msg.user || 'åç„¡ã—'}:</strong> <br><img src="${msg.image}" style="max-width:200px; border-radius:10px;">`;
      } else if(msg.stamp){
        div.innerHTML = `<strong>${msg.user || 'åç„¡ã—'}:</strong> <br> <img src="${msg.stamp}" style="width:50px;">`;
      } else {
        div.innerHTML = `<strong>${msg.user || 'åç„¡ã—'}:</strong> ${msg.text}`;
      }
      chat.appendChild(div);
    });
    chat.scrollTop = chat.scrollHeight; // å¸¸ã«ä¸‹ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  }
});

// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
sendBtn.addEventListener("click", async () => {
  const text = textInput.value.trim();
  const file = imageInput.files[0];
  if(text){
    await push(messagesRef, { text, time: Date.now() });
    textInput.value = "";
  }
  if(file){
    const storageRef = sRef(storage, `images/${Date.now()}_${file.name}`);
    await uploadBytes(storageRef, file);
    const url = await getDownloadURL(storageRef);
    await push(messagesRef, { image: url, time: Date.now() });
    imageInput.value = "";
  }
});

// ã‚¹ã‚¿ãƒ³ãƒ—é€ä¿¡
stampBtns.forEach(btn => {
  btn.addEventListener("click", async () => {
    const url = btn.dataset.url;
    await push(messagesRef, { stamp: url, time: Date.now() });
  });
});
</script>

<style>
body {
  font-family: sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
  background: #f6f6f6;
  height: 100vh;
  margin: 0;
}
#chat {
  flex: 1;
  width: 90%;
  max-width: 500px;
  background: white;
  border-radius: 20px;
  margin-top: 20px;
  padding: 10px;
  overflow-y: auto;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}
#input {
  display: flex;
  width: 90%;
  max-width: 500px;
  margin: 10px;
}
#text {
  flex: 1;
  border: 1px solid #ccc;
  border-radius: 15px;
  padding: 10px;
}
#send {
  margin-left: 10px;
  background: #007aff;
  color: white;
  border: none;
  border-radius: 15px;
  padding: 10px 20px;
  cursor: pointer;
}
.message {
  margin-bottom: 10px;
}
.stamp-btn {
  cursor: pointer;
  margin: 5px;
  width: 50px;
}
</style>
</head>
<body>
<h2>ğŸ’¬ å‹é”ãƒãƒ£ãƒƒãƒˆ</h2>
<div id="chat"></div>
<div id="input">
  <input id="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." />
  <input type="file" id="image" accept="image/*"/>
  <button id="send">é€ä¿¡</button>
</div>
<div id="stamps">
  <h3>ã‚¹ã‚¿ãƒ³ãƒ—</h3>
  <img class="stamp-btn" src="https://example.com/stamp1.png" data-url="https://example.com/stamp1.png">
  <img class="stamp-btn" src="https://example.com/stamp2.png" data-url="https://example.com/stamp2.png">
</div>
</body>
</html>
